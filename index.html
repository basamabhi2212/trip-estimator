<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trip Fare Calculator</title>
  <script src="rates.js"></script>
</head>
<body>
  <h1>Trip Fare Calculator</h1>
  <form id="fareForm">
    <label>Start Date & Time:
      <input type="datetime-local" id="startDateTime" required />
    </label>
    <label>End Date & Time:
      <input type="datetime-local" id="endDateTime" required />
    </label>
    <label>Uniform:
      <select id="uniform" required>
        <option value="no">No</option>
        <option value="yes">Yes</option>
      </select>
    </label>
    <label>Trip Type:
      <select id="tripType" required>
        <option value="instation">In-station</option>
        <option value="outstation">Out-station</option>
      </select>
    </label>
    <label>Trip Route:
      <select id="tripRoute" required>
        <option value="oneway">One Way</option>
        <option value="roundtrip">Round Trip</option>
      </select>
    </label>
    <button type="submit">Calculate Fare</button>
  </form>

  <div id="results"></div>

  <script>
    function getPricingKey(uniform, tripType, tripRoute) {
      return `uniform_${uniform}_${tripType}_${tripRoute}`;
    }

    function isDayTime(hour) {
      return hour >= 7 && hour < 22; // 7 AM to 9:59 PM is day
    }

    function calculateDayNightMinutes(startDate, endDate) {
      let dayMinutes = 0, nightMinutes = 0;
      const current = new Date(startDate);

      while (current < endDate) {
        const next = new Date(current.getTime() + 60000);
        const hour = current.getHours();
        if (isDayTime(hour)) dayMinutes++;
        else nightMinutes++;
        current.setTime(next.getTime());
      }
      return { dayMinutes, nightMinutes };
    }

    function getRate(minutes, pricingTiers) {
      for (const tier of pricingTiers) {
        if (minutes >= tier.min && minutes <= tier.max) {
          return { day: tier.day, night: tier.night };
        }
      }
      return pricingTiers.length ? { day: pricingTiers.at(-1).day, night: pricingTiers.at(-1).night } : { day: 0, night: 0 };
    }

    function roundPrice(value) {
      const decimal = value % 1;
      return decimal > 0.6 ? Math.ceil(value) : Math.floor(value) + (decimal > 0 ? 1 : 0);
    }

    function calculateFare(startDateTime, endDateTime, uniform, tripType, tripRoute) {
      const start = new Date(startDateTime);
      const end = new Date(endDateTime);
      let totalMinutes = Math.round((end - start) / 60000);
      if (totalMinutes < 120) totalMinutes = 120;

      const key = getPricingKey(uniform, tripType, tripRoute);
      const pricingTiers = pricingData[key];
      if (!pricingTiers) throw new Error('Invalid pricing');

      const { dayMinutes, nightMinutes } = calculateDayNightMinutes(start, end);
      const rates = getRate(totalMinutes, pricingTiers);
      const basePrice = dayMinutes * rates.day + nightMinutes * rates.night;
      const gst = basePrice * 0.18;
      const totalPrice = basePrice + gst;

      return {
        totalMinutes,
        dayMinutes,
        nightMinutes,
        rates,
        basePrice: roundPrice(basePrice),
        gst: roundPrice(gst),
        totalPrice: roundPrice(totalPrice)
      };
    }

    document.getElementById('fareForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const start = document.getElementById('startDateTime').value;
      const end = document.getElementById('endDateTime').value;
      const uniform = document.getElementById('uniform').value;
      const type = document.getElementById('tripType').value;
      const route = document.getElementById('tripRoute').value;

      try {
        const result = calculateFare(start, end, uniform, type, route);
        document.getElementById('results').innerHTML = `
          <p>Total Minutes: ${result.totalMinutes}</p>
          <p>Trip time: ${result.dayMinutes} min (day), ${result.nightMinutes} min (night)</p>
          <p>Rate per Minute: ₹${result.rates.day} (day), ₹${result.rates.night} (night)</p>
          <p>Base Price: ₹${result.basePrice}</p>
          <p>GST (18%): ₹${result.gst}</p>
          <p><strong>Total Price: ₹${result.totalPrice}</strong></p>
        `;
      } catch (err) {
        alert(err.message);
      }
    });
  </script>
</body>
</html>
